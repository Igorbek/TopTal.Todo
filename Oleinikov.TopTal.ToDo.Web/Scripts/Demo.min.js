var ToDo;(function(n){(function(t){function u(){_ViewModel=new i,_ViewModel.tryAutoLogin(),ko.bindingHandlers.datepicker={init:function(n,t){var i=t(),r=$(n);if(r.data("datepicker")?r.datepickerSetDate(ko.unwrap(i)):r.datepicker({initDate:ko.unwrap(i)}),ko.isObservable(i))r.on("date-selected",function(n,t,r){i(r.toDate())})},update:function(n,t){var i=$(n);i.datepickerSetDate(ko.unwrap(t()))}},$(function(){return ko.applyBindings(_ViewModel)})}var i=function(){function t(){var t=this;this.Token=ko.observable(null),this.User={Name:ko.observable(null),Password:ko.observable(null)},this.CurrentUser={Name:ko.observable(null),CreatedOn:ko.observable(null)},this.list={orderBy:ko.observable("priority"),orderOptions:["priority","due date","title","creation time","update time","state"],orderDir:ko.observable("desc"),filter:ko.observable("active"),filterOptions:["active","completed","all"],items:ko.observable([])},this.items=ko.observableArray([]),this.selectedItem=ko.observable(null),this.editItem=ko.observable(null),this.ajax=new n.Api.jQueryHttpService,this.priorities=["Low","Medium","High"],this.priorityValues={None:0,Low:1,Medium:2,High:3},this.states=["New","InProgress","Completed"],this.stateValues={New:0,InProgress:1,Completed:2},this.isTryingAutoLogin=ko.observable(!1),this.list.items=ko.computed(function(){var n=function(n){return t.list.orderBy()=="priority"?t.priorityValues[n.priority()]:t.list.orderBy()=="due date"?n.completeDue():t.list.orderBy()=="title"?n.title():t.list.orderBy()=="creation time"?n.createdOn():t.list.orderBy()=="state"?t.stateValues[n.state()]:t.list.orderBy()=="update time"?n.updatedOn():null},i=Enumerable.from(t.items()).where(function(n){return t.list.filter()=="active"?n.state()=="New"||n.state()=="InProgress":t.list.filter()=="completed"?n.state()=="Completed":!0});return(t.list.orderDir()=="desc"?i.orderByDescending(n):i.orderBy(n)).toArray()})}return t.catchApiError=function(n){return function(t){return n(t.responseJSON)}},t.prototype.Login=function(){this.LoginOrRegister(n.Api.Account.Login)},t.prototype.Register=function(){this.LoginOrRegister(n.Api.Account.Register)},t.prototype.LoginOrRegister=function(n){return this.processLogin(n({Name:this.User.Name(),Password:this.User.Password()}).execute(this.ajax))},t.prototype.processLogin=function(n,i){typeof i=="undefined"&&(i=!0);var r=this,u=n.then(function(n){r.CurrentUser.Name(n.User.Name),r.CurrentUser.CreatedOn(new Date(n.User.CreatedOn)),r.Token(n.AuthToken),r.LoadItems(),n.AutoLoginToken&&r.saveAutoLoginToken(n.AutoLoginToken)});return i?u.fail(t.catchApiError(function(n){return window.alert(n.Message)})):u},t.prototype.saveAutoLoginToken=function(n){window.localStorage&&(n?window.localStorage.setItem("autoLoginToken",n):window.localStorage.removeItem("autoLoginToken"))},t.prototype.getAutoLoginToken=function(){return window.localStorage&&window.localStorage.getItem("autoLoginToken")},t.prototype.logout=function(){this.saveAutoLoginToken(null),this.User.Name(null),this.User.Password(null),this.Token(null)},t.prototype.tryAutoLogin=function(){var t=this,i=this.getAutoLoginToken();i&&(this.isTryingAutoLogin(!0),this.processLogin(n.Api.Account.Login({Name:"_autologin",Password:i}).execute(this.ajax),!1).always(function(){return t.isTryingAutoLogin(!1)}).fail(function(){return t.saveAutoLoginToken(null)}))},t.prototype.LoadItems=function(){var i=this;n.Api.Items.List(this.Token()).execute(this.ajax).then(function(n){i.items.destroyAll();for(var t in n)i.items.push(new r(i,n[t]))}).fail(t.catchApiError(function(n){return window.alert(n.Message)}))},t.prototype.selectItem=function(n){this.selectedItem(this.selectedItem()==n?null:n)},t.prototype.create=function(){new r(this,{State:"New",Title:"",Priority:"None"},!0).edit()},t}(),r;t.ViewModel=i,r=function(){function t(n,t,i){typeof i=="undefined"&&(i=!1);var r=this;this.model=n,this.item=t,this.isNew=i,this.title=ko.observable(""),this.description=ko.observable(""),this.priority=ko.observable(""),this.completeDue=ko.observable(null),this.createdOn=ko.observable(null),this.updatedOn=ko.observable(null),this.state=ko.observable(""),this.completeDueSet=ko.observable(!1),this.isSaving=ko.observable(!1),this.loadFromItem(),this.completeDueSet=ko.computed({read:function(){return!!r.completeDue()},write:function(n){n&&!r.completeDue()?r.completeDue(new Date):!n&&r.completeDue()&&r.completeDue(null)}})}return t.prototype.loadFromItem=function(){this.title(this.item.Title),this.description(this.item.Description),this.priority(this.item.Priority),this.completeDue(this.item.CompleteDue?new Date(this.item.CompleteDue):null),this.createdOn(this.item.CreatedOn?new Date(this.item.CreatedOn):null),this.updatedOn(this.item.UpdatedOn?new Date(this.item.UpdatedOn):null),this.state(this.item.State)},t.prototype.saveToItem=function(){this.item.Title=this.title(),this.item.Description=this.description(),this.item.Priority=this.priority(),this.item.CompleteDue=this.completeDue()?this.completeDue().toISOString():null,this.item.State=this.state()},t.prototype.getCssClasses=function(){var n={selected:this.model.selectedItem()==this},t=this.title()||"",i=this.description()||"";return t.length>40||i.length>200?n.triple=!0:(t.length>20||i.length>100)&&(n.double=!0),n},t.prototype.remove=function(){var t=this;this.model.selectedItem()==this&&this.model.selectedItem(null),this.model.items.remove(this),this.item.Id&&!this.isSaving()&&(this.isSaving(!0),n.Api.Items.Delete(this.model.Token(),this.item.Id).execute(this.model.ajax).fail(i.catchApiError(function(n){return window.alert(n.Message)})).always(function(){return t.isSaving(!1)}))},t.prototype.edit=function(){this.saveToItem(),this.model.editItem(this)},t.prototype.complete=function(){this.isSaving()||(this.state("Completed"),this.checkSelected(),this.save())},t.prototype.uncomplete=function(){this.isSaving()||(this.state("New"),this.checkSelected(),this.save())},t.prototype.startProgress=function(){this.isSaving()||(this.state("InProgress"),this.checkSelected(),this.save())},t.prototype.stopProgress=function(){this.isSaving()||(this.state("New"),this.checkSelected(),this.save())},t.prototype.checkSelected=function(){this.model.selectedItem()!=this||Enumerable.from(this.model.list.items()).contains(this)||this.model.selectedItem(null)},t.prototype.done=function(){this.isNew&&(this.isNew=!1,this.model.items.push(this)),this.checkSelected(),this.model.editItem()==this&&this.model.editItem(null),this.save()},t.prototype.cancel=function(){this.isNew||this.loadFromItem(),this.checkSelected(),this.model.editItem()==this&&this.model.editItem(null)},t.prototype.save=function(){var t=this;this.isSaving()||(this.isSaving(!0),this.saveToItem(),(this.item.Id?n.Api.Items.Update(this.model.Token(),this.item.Id,this.item):n.Api.Items.Create(this.model.Token(),this.item)).execute(this.model.ajax).fail(i.catchApiError(function(n){return window.alert(n.Message)})).then(function(n){t.item=n,t.loadFromItem()}).always(function(){return t.isSaving(!1)}))},t}(),t.ItemViewModel=r,t.Init=u})(n.Demo||(n.Demo={}));var t=n.Demo})(ToDo||(ToDo={}))